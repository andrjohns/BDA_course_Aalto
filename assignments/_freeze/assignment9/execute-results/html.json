{
  "hash": "40ab70e7fe8ed4977f0ee49d9769831d",
  "result": {
    "markdown": "---\ntitle: \"Assignment 9\"\nsubtitle: \"Decision analysis\"\nauthor: \"Aki Vehtari et al.\"\nformat:\n  html:\n    toc: true\n    code-tools: true\n    code-line-numbers: true\n    standalone: true\n    self-contained: true\n    embed-resources: true\n    number-sections: true\n    mainfont: Georgia, serif\n    #fontsize: 12pt\n    page-layout: article\n# reference-location: margin\n# citation-location: margin\ncomments:\n  hypothesis: true\neditor: source\nfilters:\n  - assignments.lua\n  - include-code-files.lua\n---\n\n\n# General information\n\n**The maximum amount of points from this assignment is 3.**\n\nWe have prepared a **quarto template specific to this assignment ([html](template9.html), [qmd](https://avehtari.github.io/BDA_course_Aalto/assignments/template9.qmd), [pdf](template9.pdf))** to help you get started. \n\n\n:::{.aalto}\nWe recommend you use [jupyter.cs.aalto.fi](https://jupyter.cs.aalto.fi) or the [docker container](docker.html).\n:::\n\n\n:::{.hint}\n**Reading instructions**:\n\n- [**The reading instructions for BDA3 Chapter 9**](../BDA3_notes.html#ch6) (decision analysis).\n\n**Grading instructions:** \n\nThe grading will be done in peergrade. \nAll grading questions and evaluations for this assignment are contained within this document\nin the collapsible **Rubric** blocks.\n\n**Installing and using `CmdStanR`:** \n\nSee the [Stan\ndemos](https://avehtari.github.io/BDA_course_Aalto/demos.html) on how to\nuse Stan in R (or Python).\n[Aalto JupyterHub](https://Aalto JupyterHub) has working R and\nCmdStanR/RStan environment and is probably the easiest way to use Stan.\n* To use CmdStanR in [Aalto JupyterHub](https://Aalto JupyterHub):<br>\n  `library(cmdstanr)`<br>\n  `set_cmdstan_path('/coursedata/cmdstan')`\n\nThe Aalto Ubuntu desktops also have the necessary libraries installed.]{.aalto}\n\nTo install Stan on your laptop, run 'install.packages(\\\"cmdstanr\\\",\nrepos = c(\\\"https://mc-stan.org/r-packages/\\\", getOption(\\\"repos\\\")))'\nin R. If you encounter problems, see additional answers in\n[**FAQ**](https://avehtari.github.io/BDA_course_Aalto/FAQ.html). [If you\ndon't succeed in short amount of time, it is probably easier to use\n[Aalto JupyterHub](https://Aalto JupyterHub).]{.aalto}\n\n[If you use `Aalto JupyterHub`, all necessary packages have been\npre-installed.]{.aalto} In your laptop, install package `cmdstanr`. Installation\ninstructions on Linux, Mac and Windows can be found at\n<https://mc-stan.org/cmdstanr/>. Additional useful packages are `loo`,\n`bayesplot` and `posterior` (but you don't need these in this\nassignment). For Python users, `PyStan`, `CmdStanPy`, and `ArviZ`\npackages are useful.\n\nStan manual can be found at <https://mc-stan.org/users/documentation/>.\nFrom this website, you can also find a lot of other useful material\nabout Stan.\n\nIf you edit files ending `.stan` in RStudio, you can click \"Check\" in\nthe editor toolbar to make syntax check. This can significantly speed-up\nwriting a working Stan model.\n\n\n:::\n\n\n::: {.callout-important collapse=false}\n# Reporting accuracy\n\n**For posterior statistics of interest, only\nreport digits that are not completely random based on the Monte Carlo standard error (MCSE).**\n\n*Example:* If you estimate $E(\\mu) \\approx 1.234$ with MCSE($E(\\mu)$)\n= 0.01, then the true expectation is likely to be between $1.204$ and\n$1.264$, it makes sense to report $E(\\mu) \\approx 1.2$.  :::\n\nSee Lecture video 4.1, [the chapter\nnotes](../BDA3_notes.html#ch10),\nand [a case\nstudy](https://avehtari.github.io/casestudies/Digits/digits.html) for\nmore information.\n:::\n\n::: {.callout-tip collapse=true}\n## Further information\n\n- The recommended tool in this course is R (with the IDE RStudio).\n- Instead of installing R and RStudio on you own computer, see [**how\n  to use R and RStudio remotely**](https://avehtari.github.io/BDA_course_Aalto/FAQ.html#How_to_use_R_and_RStudio_remotely).\n- If you want to install R and RStudio locally, \n  download [R and RStudio](https://posit.co/download/rstudio-desktop/).\n- There are tons of tutorials, videos and introductions to R and\n  RStudio online. You can find some initial hints from [**RStudio\n  Education pages**](https://education.rstudio.com/).\n- When working with R, we recommend writing the report using `quarto` and the provided template.\n  The template includes the formatting instructions and how to include code and figures.\n- Instead of `quarto`, you can use other software to make the PDF\n  report, but the the same instructions for formatting should be used.\n- Report all results in a single, **anonymous** \\*.pdf -file and\n  submit it in [**peergrade.io**](peergrade.io).\n- The course has its own R package `aaltobda` with data and\n  functionality to simplify coding. The package is pre-installed in JupyterHub.\n  To install the package on your own system, run\n  the following code (upgrade=\\\"never\\\" skips question about updating other packages):\n```{.r}\ninstall.packages(\"remotes\")\nremotes::install_github(\"avehtari/BDA_course_Aalto\", subdir = \"rpackage\", upgrade=\"never\")\n```\n-   Many of the exercises can be checked automatically using the R\n    package `markmyassignment` (pre-installed in JupyterHub).\n    Information on how to install and use the\n    package can be found in [the `markmyassignment` documentation](https://cran.r-project.org/web/packages/markmyassignment/vignettes/markmyassignment.html).\n    There is no need to include `markmyassignment` results in the\n    report.\n-   Recommended additional self study exercises for each chapter in BDA3\n    are listed in the course web page. These will help to gain deeper understanding of the topic.\n-   Common questions and answers regarding installation and technical\n    problems can be found in [Frequently Asked Questions\n    (FAQ)](https://avehtari.github.io/BDA_course_Aalto/FAQ.html).\n-   Deadlines for all assignments can be found on the course web page\n    and in Peergrade. You can set email alerts for the deadlines in\n    Peergrade settings.\n-   You are allowed to discuss assignments with your friends, but it is\n    not allowed to copy solutions directly from other students or from\n    internet.\n-   You can copy, e.g., plotting code from the course demos,\n    but really try to solve the actual assignment problems with your own\n    code and explanations.\n-   Do not share your answers publicly.\n-   Do not copy answers from the internet or from previous years. We compare\n    the answers to the answers from previous years and to the answers\n    from other students this year.\n-   Use of AI is allowed on the course, but the most of the work needs to by the student, and you need to report\n    whether you used AI and in which way you used them (See [points 5 and 6 in Aalto guidelines for use of AI in teaching](https://www.aalto.fi/en/services/guidance-for-the-use-of-artificial-intelligence-in-teaching-and-learning-at-aalto-university)).\n-   All suspected plagiarism will be\n    reported and investigated. See more about the [**Aalto University\n    Code of Academic Integrity and Handling Violations\n    Thereof**](https://into.aalto.fi/display/ensaannot/Aalto+University+Code+of+Academic+Integrity+and+Handling+Violations+Thereof).\n-   Do not submit empty PDFs, almost empty PDFs, copy of the questions, nonsense generated by yourself or AI, as these are just\n    harming the other students as they can't do peergrading for the\n    empty or nonsense submissions. Violations of this rule will be\n    reported and investigated in the same way was plagiarism.\n-   If you have any suggestions or improvements to the course material,\n    please post in the course chat feedback channel, create an issue, or\n    submit a pull request to the public repository!\n\n\n:::\n\n\n        \n::: {.rubric weight=7.5}    \n\n* Can you open the PDF and it's not blank nor nonsense?     \n* Is the report anonymous?    \n     \n:::      \n\n\n\n\n\n\n\n\nThis exercise is an example of a decision analysis (DA). In a broad context, this means optimizing over different decisions that lead to different outcomes that all have different utilities. In a Bayesian context, this means using posterior distributions to make decisions.\n\n# Escaping from the chicken coop\n\nYou are an adult chicken living in an organic chicken commune, where life is great, if a bit boring. \nYou have settled in comfortably, but you want something more for your offspring. \nYour traveling corvid friends tell you of places where chickens eat corn all day, \nget ferried around in [mobile chicken coops to see the world](https://www.chicken-trailer.de/en/chicken-trailer-en/chicken-trailer-330) or [get mental stimulation by being trained humanely to perform\ntricks](https://en.wikipedia.org/wiki/Marian_Breland_Bailey#:~:text=Popular%20acts%20included,that%20played%20basketball.).\nThe chicken elders have gained access to the computers of your human caretakers\nand have found the results of a complicated statistical analysis of the growth curves \nof your relatives. Because you are a chicken, you don't care about convergence diagnostics or priors.\n\n**Your task is to maximizes the chance of escape for your offspring.**\n\n::: {.subtask letter=a}\nCompute and visualize the **expected chicken weight for days 1--40 per diet**, according to the\nmodel provided in the template. Do the predictions look reasonable? Why/why not? \n:::\n::: {.hint}\nTo sample a \"new chicken\" from the posterior, use [posterior_predict](https://rdrr.io/cran/brms/man/posterior_epred.brmsfit.html) with options `newdata=..., allow_new_levels=TRUE, sample_new_levels=\"gaussian\"`, where you pass a dataframe as `newdata` which has a \"new\" chicken ID `Chick` and appropriate values for `Time` and `Diet`.\n:::\n\n\n:::{.subrubric}\n* Does the plot look right and is it readable?\n* Has it been recognized that the prediction time **...**?\n:::\n\nYour chicken elders have been meticulously collecting data on what kind of characteristics have allowed\nprevious chickens to escape. They have found out that both the age and the weight influence the (daily)\nprobability of escape for a chicken:\n\n* If the chicken is too young, it is not yet mature enough to venture out into the world.\n* If the chicken is too old, it will not try to escape anymore.\n* If the chicken is small and has just the right size, it can try to squeze through a tiny crack in the fence.\n* If the chicken is big enough, it is strong enough to try to fly over the fence.\n* No matter the size, there is always a small residual probability that the chicken can escape.\n\nEvery day, chickens will try to escape if they are of the right age. \nTheir daily escape probability $e(\\text{day}, \\text{weight})$ is implemented in the `daily_probability_of_escape(day, weight)` function.\nThe probability that a chicken with daily weights $w = (w_1,\\dots,w_N)$ **has not escaped** after $i+1$ days can be computed as follows: \n$$\n  f_{i+1} = f_i \\, (1 - e(i, w_i))\n$$\nThe `chickenwise_probability_of_escape(weights)` computes the probability that a chicken **has escaped** after `length(weights)` days.\n\n\n\n:::: {.content-hidden when-format=\"pdf\"}\n::: {.callout-tip collapse=true}\n\n###  Chickenwise probability of escape function\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbump <- function(x, loc=0, scale=1){\n  xi = (x - loc) / scale\n  ifelse(abs(xi) < 1, exp(-1/(1-xi^2)), 0.)\n}\ndaily_probability_of_escape <- function(day, weight){\n  # Expects a day and a weight and computes the daily probability of escape \n  bump(day, 30, 10) * (1e-2 + bump(weight, 200, 150)+bump(weight, 700, 150))\n}\nchickenwise_probability_of_escape <- function(weights){\n  # Expects a vector of daily weights from day 1 to N and computes the probability of \n  # escape at the end of the time series\n  prob_of_failure = 1\n  for(day in 1:length(weights)){\n    prob_of_failure = prob_of_failure * (1-daily_probability_of_escape(day, weights[day]))\n  }\n  return(1 - prob_of_failure)\n}\n```\n:::\n\n\n:::\n::::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndays = 1:40\nweights = 1:900\nheatmap_matrix = outer(days,weights,daily_probability_of_escape)\nimage(days, weights, heatmap_matrix, xlab=\"day\", ylab=\"weight\", main=\"Daily probability of escape\")\n```\n\n::: {.cell-output-display}\n![Daily probability of escape for a given day and weight](assignment9_files/figure-html/fig-prob-1.png){#fig-prob width=672}\n:::\n:::\n\n\n::: {.subtask}\nCompute and visualize the **distribution of the chickenwise probabilities of escape per diet**, \naccording to the model provided in the template.\n:::\n::: {.hint}\nYou can reuse the predictions you created in the previous subtask. \n**Work with the draws to compute the chickenwise probability of escape first, and then take the expectation!** \n:::\n\n:::{.subrubric}\n* Does the plot look right and is it readable?\n:::\n\n::: {.subtask}\nCompute the **expected probability of escape for each diet**. \nWhy would it be wrong to compute the expected probability of escape by\napplying the `chickenwise_probability_of_escape` function in the template to the \n*daily expected chicken weights per diet* computed in subtask 2.a? \nHow does the correctly calculated value compare to the incorrectly calculated value?\nWhy is one higher than the other?\n:::\n\n:::{.subrubric}\n* Do the results look correct and have they been presented in a readable way? They should be roughly **...** for the correct calculation and **...** for the wrong calculation.\n* Has it been explained that the expected probability of escape depends on **...**?\n* Has it been explained that **...** is lower because **...**?\n:::\n\n# Overall quality of the report\n\n::: {.rubric weight=7.5}\n\n* Does the report include whether AI was used and if was used explanation on how it was used?\n    - No\n    - Yes\n* Does the report follow the formatting instructions?\n    - Not at all \n    - Little\n    - Mostly\n    - Yes\n* In case the report doesn't fully follow the formatting instructions, specify the formatting instruction that\nis not followed.\nIf applicable, specify the page of the report, where this difference in formatting is visible.\n* Please provide also feedback on the presentation (e.g. text, layout, flow of the responses, figures,\nfigure captions). Part of the course is practicing making data analysis reports. By providing feedback\non the report presentation and other students can learn what they can improve or what they already\ndid well. You should be able to provide constructive or positive feedback for all non-empty reports.\nIf you think the report is perfect, and you can't come up with any suggestions how to improve, you can provide feedback on what you liked and why you think the report is better than yours.\n\n\n::: \n\n",
    "supporting": [
      "assignment9_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}