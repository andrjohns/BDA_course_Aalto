{
  "hash": "874a904b454d43e2af30fd4d85a88a7c",
  "result": {
    "markdown": "---\ntitle: \"Assignment 6\"\nauthor: anonymous # <-- hand in anonymously\nformat:\n  html:\n    toc: true\n    code-tools: true\n    code-line-numbers: true\n    number-sections: true\n    mainfont: Georgia, serif\n    page-layout: article\n  pdf:\n    geometry:\n    - left=1cm,top=1cm,bottom=1cm,right=7cm\n    number-sections: true\n    code-annotations: none\neditor: source\n---\n\n\n\n\n# General information\n\nThis is the template for [assignment 6](assignment6.html). You can download the [broken stan-file](./additional_files/assignment6_linear_model.stan) and the [qmd-file](https://avehtari.github.io/BDA_course_Aalto/assignments/template6.qmd) or copy the code from this rendered document after clicking on `</> Code` in the top right corner.\n\n**Please replace the instructions in this template by your own text, explaining what you are doing in each exercise.**\n\n\n\n:::: {.content-hidden when-format=\"pdf\"}\n::: {.callout-warning collapse=false}\n\n## Setup\n\n\n*This block will only be visible in your HTML output, but will be hidden when rendering to PDF with quarto for the submission.*\n**Make sure that this does not get displayed in the PDF!**\n\n\n\n\nJupyterHub has all the needed packages pre-installed.\n\nThe following installs and loads the `aaltobda` package:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif(!require(aaltobda)){\n    install.packages(\"aaltobda\", repos = c(\"https://avehtari.github.io/BDA_course_Aalto/\", getOption(\"repos\")))\n    library(aaltobda)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: aaltobda\n```\n:::\n:::\n\n\nThe following installs and loads the [`latex2exp` package](https://github.com/stefano-meschiari/latex2exp), which allows us to use LaTeX in plots:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif(!require(latex2exp)){\n    install.packages(\"latex2exp\")\n    library(latex2exp)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: latex2exp\n```\n:::\n:::\n\n\nThe following installs and loads the [`posterior` package](https://github.com/stan-dev/posterior) which imports the `rhat_basic()` function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif(!require(posterior)){\n    install.packages(\"posterior\")\n    library(posterior)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: posterior\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThis is posterior version 1.4.0\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'posterior'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:aaltobda':\n\n    mcse_quantile\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    mad, sd, var\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    %in%, match\n```\n:::\n:::\n\n\nThe following installs and loads the [`ggplot2` package](https://ggplot2.tidyverse.org/), the [`bayesplot` package](https://mc-stan.org/bayesplot/index.html) and the [`dplyr` package](https://dplyr.tidyverse.org/)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif(!require(ggplot2)){\n    install.packages(\"ggplot2\")\n    library(ggplot2)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: ggplot2\n```\n:::\n\n```{.r .cell-code}\nif(!require(bayesplot)){\n    install.packages(\"bayesplot\")\n    library(bayesplot)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: bayesplot\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThis is bayesplot version 1.10.0\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n- Online documentation and vignettes at mc-stan.org/bayesplot\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n- bayesplot theme set to bayesplot::theme_default()\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n   * Does _not_ affect other ggplot2 plots\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n   * See ?bayesplot_theme_set for details on theme setting\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'bayesplot'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:posterior':\n\n    rhat\n```\n:::\n\n```{.r .cell-code}\nif(!require(dplyr)){\n    install.packages(\"dplyr\")\n    library(dplyr)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: dplyr\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\nif(!require(tidyr)){\n    install.packages(\"tidyr\")\n    library(tidyr)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: tidyr\n```\n:::\n\n```{.r .cell-code}\n# Some additional set-up to make plots legible\nggplot2::theme_set(theme_minimal(base_size = 14))\nbayesplot::bayesplot_theme_set(theme_minimal(base_size = 14))\n# register_knitr_engine()\n```\n:::\n\n\nThe following installs and loads the [`cmdstanr` package](https://mc-stan.org/cmdstanr/) and tries to install `cmdstan`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif(!require(cmdstanr)){\n    install.packages(\"cmdstanr\", repos = c(\"https://mc-stan.org/r-packages/\", getOption(\"repos\")))\n    library(cmdstanr)\n}\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: cmdstanr\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThis is cmdstanr version 0.5.3\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n- CmdStan path: /root/.cmdstan/cmdstan-2.31.0\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n- CmdStan version: 2.31.0\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nA newer version of CmdStan is available. See ?install_cmdstan() to install it.\nTo disable this check set option or environment variable CMDSTANR_NO_VER_CHECK=TRUE.\n```\n:::\n\n```{.r .cell-code}\ncmdstan_installed <- function(){\n  res <- try(out <- cmdstanr::cmdstan_path(), silent = TRUE)\n  !inherits(res, \"try-error\")\n}\nif(!cmdstan_installed()){\n    install_cmdstan()\n}\n```\n:::\n\n\n\n:::\n::::\n\n\n# Stan warm-up: linear model of BDA retention with Stan (2 points)\n\n## (b)\n\n\nWrite your answers/code here!\n\n\n\n:::: {.content-hidden when-format=\"pdf\"}\n::: {.callout-warning collapse=false}\n\n## Data preparation and sampling from the posterior\n\n\n*This block will only be visible in your HTML output, but will be hidden when rendering to PDF with quarto for the submission.*\n**Make sure that this does not get displayed in the PDF!**\n\n\n\n\n**Data assembly happens here**:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# These are our observations y: the proportion of students handing in each assignment (1-8),\n# sorted by year (row-wise) and assignment (column-wise).\n# While the code suggest a matrix structure,\n# the result will actually be a vector of length N = no_years * no_assignments\npropstudents<-c(c(176, 174, 158, 135, 138, 129, 126, 123)/176,\n                c(242, 212, 184, 177, 174, 172, 163, 156)/242,\n                c(332, 310, 278, 258, 243, 242, 226, 224)/332,\n                c(301, 269, 231, 232, 217, 208, 193, 191)/301,\n                c(245, 240, 228, 217, 206, 199, 191, 182)/245)\n# These are our predictors x: for each observation, the corresponding assignment number.\nassignment <- rep(1:8, 5)\n# These are in some sense our test data: the proportion of students handing in the last assignment (9),\n# sorted by year.\n# Usually, we would not want to split our data like that and instead\n# use e.g. Leave-One-Out Cross-Validation (LOO-CV, see e.g. http://mc-stan.org/loo/index.html)\n# to evaluate model performance.\npropstudents9 = c(121/176, 153/242, 218/332, 190/301, 175/245)\n# The total number of assignments\nno_assignments = 9\n# The assignment numbers for which we want to generate predictions\nx_predictions = 1:no_assignments\n# (Cmd)Stan(R) expects the data to be passed in the below format:\nmodel_data = list(N=length(assignment),\n                 x=assignment,\n                 y=propstudents,\n                 no_predictions=no_assignments,\n                 x_predictions=x_predictions)\n```\n:::\n\n\n**Sampling from the posterior distribution happens here**:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# This reads the file at the specified path and tries to compile it.\n# If it fails, an error is thrown.\nretention_model = cmdstan_model(\"./additional_files/assignment6_linear_model.stan\")\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in initialize(...): Assertion on 'stan_file' failed: File does not exist: './additional_files/assignment6_linear_model.stan'.\n```\n:::\n\n```{.r .cell-code}\n# This \"out <- capture.output(...)\" construction suppresses output from cmdstanr\n# See also https://github.com/stan-dev/cmdstanr/issues/646\nout <- capture.output(\n    # Sampling from the posterior distribution happens here:\n    fit <- retention_model$sample(data=model_data, refresh=0, show_messages=FALSE)\n)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in withVisible(...elt(i)): object 'retention_model' not found\n```\n:::\n:::\n\n\n**Draws postprocessing happens here**:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# This extracts the draws from the sampling result as a data.frame.\ndraws_df = fit$draws(format=\"draws_df\")\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in eval(expr, envir, enclos): object 'fit' not found\n```\n:::\n\n```{.r .cell-code}\n# This does some data/draws wrangling to compute the 5, 50 and 95 percentiles of\n# the mean at the specified covariate values (x_predictions).\n# It can be instructive to play around with each of the data processing steps\n# to find out what each step does, e.g. by removing parts from the back like \"|>  gather(pct,y,-x)\"\n# and printing the resulting data.frame.\nmu_quantiles_df = draws_df |>\n      subset_draws(variable = c(\"mu_pred\")) |>\n      summarise_draws(~quantile2(.x, probs = c(0.05, .5, 0.95))) |>\n      mutate(x = 1:9) |>\n      pivot_longer(c(q5, q50, q95), names_to = c(\"pct\"))\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in UseMethod(\"subset_draws\"): no applicable method for 'subset_draws' applied to an object of class \"function\"\n```\n:::\n\n```{.r .cell-code}\n# Same as above, but for the predictions.\ny_quantiles_df = draws_df |>\n      subset_draws(variable = c(\"y_pred\")) |>\n      summarise_draws(~quantile2(.x, probs = c(0.05, .5, 0.95))) |>\n      mutate(x = 1:9) |>\n      pivot_longer(c(q5, q50, q95), names_to = c(\"pct\"))\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in UseMethod(\"subset_draws\"): no applicable method for 'subset_draws' applied to an object of class \"function\"\n```\n:::\n:::\n\n\n\n:::\n::::\n\n\n::: {.both}\n**Plotting happens here**:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  # scatter plot of the training data:\n  geom_point(\n    aes(x, y, color=assignment),\n    data=data.frame(x=assignment, y=propstudents, assignment=\"1-8\")\n) +\n  # scatter plot of the test data:\n  geom_point(\n    aes(x, y, color=assignment),\n    data=data.frame(x=no_assignments, y=propstudents9, assignment=\"9\")\n) +\n  # you have to tell us what this plots:\n  geom_line(aes(x,y=value,linetype=pct), data=mu_quantiles_df, color='grey', linewidth=1.5) +\n  # you have to tell us what this plots:\n  geom_line(aes(x,y=value,linetype=pct), data=y_quantiles_df, color='red') +\n  # adding xticks for each assignment:\n  scale_x_continuous(breaks=1:no_assignments) +\n  # adding labels to the plot:\n  labs(y=\"assignment submission %\", x=\"assignment number\") +\n  # specifying that line types repeat:\n  scale_linetype_manual(values=c(2,1,2)) +\n  # Specify colours of the observations:\n  scale_colour_manual(values = c(\"1-8\"=\"black\", \"9\"=\"blue\")) +\n  # remove the legend for the linetypes:\n  guides(linetype=\"none\")\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in fortify(data): object 'mu_quantiles_df' not found\n```\n:::\n:::\n\n\n:::\n\n\n:::: {.content-hidden when-format=\"pdf\"}\n::: {.callout-warning collapse=false}\n\n## Quick check for sampling convergence\n\n\n*This block will only be visible in your HTML output, but will be hidden when rendering to PDF with quarto for the submission.*\n**Make sure that this does not get displayed in the PDF!**\n\n\n\n\nIf your model is correctly implemented, sampling from the posterior distribution should have been successful.\nYou can check whether Stan thinks that sampling succeeded by inspecting the output of the below command,\nwhich you should be able to interpret with a little help from the [CmdStan User's Guide](https://mc-stan.org/docs/cmdstan-guide/diagnose.html).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit$cmdstan_diagnose()\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in eval(expr, envir, enclos): object 'fit' not found\n```\n:::\n:::\n\n\n\n:::\n::::\n\n\n\n## (c)\n\n\nWrite your answers/code here!\n\n\n# Generalized linear model: Bioassay with Stan (4 points)\n\n## (d)\n\n\nWrite your answers/code here!\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata(\"bioassay\")\n```\n:::\n\n\n\n\n\n## (e)\n\n\nWrite your answers/code here!\n\n\n\n## (f)\n\n\nWrite your answers/code here!\n\n\n\n## (g)\n\n\nWrite your answers/code here!\n",
    "supporting": [
      "template6_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}